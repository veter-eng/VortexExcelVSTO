<Window x:Class="VortexExcelAddIn.Views.TempoDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:VortexExcelAddIn"
        Title="ConfiguraÃ§Ã£o de AgregaÃ§Ã£o Temporal"
        Width="750" Height="850"
        WindowStartupLocation="CenterScreen"
        ResizeMode="CanResize"
        Background="#F5F5F5">

    <Window.Resources>
        <!-- Converters -->
        <local:BoolToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:InverseBoolConverter x:Key="InverseBooleanConverter"/>

        <!-- Style para GroupBox -->
        <Style TargetType="GroupBox">
            <Setter Property="Margin" Value="0,0,0,15"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="BorderBrush" Value="#BDC3C7"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="FontSize" Value="13"/>
        </Style>

        <!-- Style para CheckBox -->
        <Style TargetType="CheckBox">
            <Setter Property="Margin" Value="0,5,0,5"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- Style para Button -->
        <Style TargetType="Button">
            <Setter Property="Padding" Value="20,10"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="MinWidth" Value="120"/>
        </Style>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Header + Status -->
            <RowDefinition Height="*"/>
            <!-- Settings -->
            <RowDefinition Height="Auto"/>
            <!-- Buttons -->
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,15">
            <!-- TÃ­tulo com Ã­cone de informaÃ§Ã£o -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                <TextBlock Text="â±ï¸ Configurar AgregaÃ§Ã£o Temporal"
                           FontSize="20"
                           FontWeight="Bold"
                           Foreground="#2C3E50"
                           VerticalAlignment="Center"/>

                <!-- Ãcone de InformaÃ§Ã£o -->
                <Button x:Name="InfoButton"
                        Content="â„¹ï¸"
                        FontSize="18"
                        Background="Transparent"
                        BorderThickness="0"
                        Foreground="#3498DB"
                        Cursor="Hand"
                        Margin="10,0,0,0"
                        Padding="5"
                        ToolTip="Clique para ver como funciona"
                        Click="InfoButton_Click">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Transparent"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#E8F4F8"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
            </StackPanel>

            <!-- Barra de Status (MOVIDA PARA O TOPO) -->
            <Border Background="{Binding StatusColor}"
                    CornerRadius="5"
                    Padding="12,8"
                    Margin="0,0,0,15">
                <StackPanel>
                    <TextBox Text="{Binding StatusMessage, Mode=OneWay}"
                             Foreground="White"
                             Background="Transparent"
                             BorderThickness="0"
                             TextWrapping="Wrap"
                             FontWeight="Medium"
                             FontSize="13"
                             IsReadOnly="True"
                             Cursor="Arrow"/>
                    <ProgressBar IsIndeterminate="True"
                                 Height="3"
                                 Margin="0,8,0,0"
                                 Background="Transparent"
                                 Foreground="White"
                                 Visibility="{Binding IsProcessing,
                                              Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </StackPanel>
            </Border>

            <!-- Seletor de Servidor -->
            <GroupBox Header="ðŸ–¥ï¸ Servidor de Dados" Margin="0,0,0,10">
                <StackPanel>
                    <ComboBox ItemsSource="{Binding AvailableServers}"
                              SelectedItem="{Binding SelectedServer}"
                              DisplayMemberPath="DisplayName"
                              FontSize="13"
                              Padding="10,5"
                              IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}"/>
                    <TextBlock Text="{Binding ServerDescription}"
                               FontSize="11"
                               Foreground="#3498DB"
                               TextWrapping="Wrap"
                               Margin="5,8,5,0"/>
                </StackPanel>
            </GroupBox>

            <!-- Token de AutenticaÃ§Ã£o -->
            <GroupBox Header="ðŸ”‘ Token de AutenticaÃ§Ã£o" Margin="0,0,0,0">
                <StackPanel>
                    <PasswordBox x:Name="TokenPasswordBox"
                                 FontSize="13"
                                 Padding="10,5"
                                 IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}"
                                 ToolTip="Token de autenticaÃ§Ã£o do InfluxDB"
                                 Margin="0,0,0,8"
                                 PasswordChanged="TokenPasswordBox_PasswordChanged"/>

                    <!-- BotÃµes de Testar e Salvar -->
                    <StackPanel Orientation="Horizontal">
                        <Button Content="{Binding TestConnectionButtonText}"
                                Command="{Binding TestConnectionCommand}"
                                Background="{Binding TestConnectionButtonBackground}"
                                Foreground="White"
                                FontWeight="Medium"
                                Padding="12,6"
                                Margin="0,0,10,0"
                                IsEnabled="{Binding IsTesting, Converter={StaticResource InverseBooleanConverter}}"/>

                        <Button Content="ðŸ’¾ Salvar ConfiguraÃ§Ã£o"
                                Command="{Binding SaveConfigurationCommand}"
                                Background="#3498DB"
                                Foreground="White"
                                FontWeight="Medium"
                                Padding="12,6"
                                IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}"/>
                    </StackPanel>

                    <TextBlock Text="ðŸ’¡ Teste a conexÃ£o antes de executar a agregaÃ§Ã£o"
                               FontSize="11"
                               Foreground="#7F8C8D"
                               TextWrapping="Wrap"
                               Margin="5,8,5,0"/>
                </StackPanel>
            </GroupBox>
        </StackPanel>

        <!-- Settings -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- Tipos de AgregaÃ§Ã£o -->
                <GroupBox Header="ðŸ“Š Tipos de AgregaÃ§Ã£o">
                    <ItemsControl ItemsSource="{Binding AvailableAggregationTypes}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <CheckBox Content="{Binding DisplayName}"
                                          IsChecked="{Binding IsSelected}"
                                          IsEnabled="{Binding DataContext.IsProcessing,
                                                      RelativeSource={RelativeSource AncestorType=Window},
                                                      Converter={StaticResource InverseBooleanConverter}}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </GroupBox>

                <!-- Janelas de Tempo -->
                <GroupBox Header="â° Janelas de Tempo" Margin="0,0,0,15">
                    <ItemsControl ItemsSource="{Binding AvailableTimeWindows}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <CheckBox Content="{Binding DisplayName}"
                                          IsChecked="{Binding IsSelected}"
                                          IsEnabled="{Binding DataContext.IsProcessing,
                                                      RelativeSource={RelativeSource AncestorType=Window},
                                                      Converter={StaticResource InverseBooleanConverter}}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </GroupBox>

                <!-- Preview dos Resultados -->
                <GroupBox Header="ðŸ‘ï¸ Preview dos Resultados"
                          Visibility="{Binding HasResults, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="Primeiros 20 registros da agregaÃ§Ã£o"
                                   FontSize="11"
                                   Foreground="#7F8C8D"
                                   Margin="0,0,0,8"/>
                        <DataGrid ItemsSource="{Binding PreviewResults}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  Height="200"
                                  CanUserSortColumns="True"
                                  CanUserResizeColumns="True"
                                  CanUserReorderColumns="False"
                                  GridLinesVisibility="Horizontal"
                                  AlternatingRowBackground="#F9F9F9"
                                  HeadersVisibility="Column"
                                  FontSize="11">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Timestamp" Binding="{Binding Time, StringFormat='dd/MM/yyyy HH:mm:ss'}" Width="140"/>
                                <DataGridTextColumn Header="Valor" Binding="{Binding Valor}" Width="100"/>
                                <DataGridTextColumn Header="AgregaÃ§Ã£o" Binding="{Binding AggregationType}" Width="90"/>
                                <DataGridTextColumn Header="Janela" Binding="{Binding TimeWindow}" Width="70"/>
                                <DataGridTextColumn Header="Coletor ID" Binding="{Binding ColetorId}" Width="*"/>
                                <DataGridTextColumn Header="Tag ID" Binding="{Binding TagId}" Width="*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </StackPanel>
                </GroupBox>
            </StackPanel>
        </ScrollViewer>

        <!-- Buttons -->
        <StackPanel Grid.Row="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0,20,0,0">
            <Button Content="ðŸ”„ Executar AgregaÃ§Ã£o"
                    Command="{Binding ApplyAggregationCommand}"
                    Background="#3498DB"
                    Foreground="White"
                    FontWeight="Bold"
                    MinWidth="160"
                    Margin="0,0,10,0"
                    IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}"/>

            <Button Content="ðŸ“Š Exportar para Excel"
                    Command="{Binding ExportToExcelCommand}"
                    Background="#27AE60"
                    Foreground="White"
                    FontWeight="Bold"
                    MinWidth="160"
                    Margin="0,0,10,0"
                    IsEnabled="{Binding HasResults}"/>

            <Button Content="âŒ Fechar"
                    Click="Cancel_Click"
                    Background="#95A5A6"
                    Foreground="White"
                    IsEnabled="{Binding IsProcessing, Converter={StaticResource InverseBooleanConverter}}"/>
        </StackPanel>
    </Grid>
</Window>
